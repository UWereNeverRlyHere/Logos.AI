# 🛡️ Алгоритм Валідації Впевненості (Confidence Validation Algorithm)

Цей документ описує багаторівневу систему оцінки надійності відповідей медичного ШІ. Алгоритм складається з чотирьох рівнів перевірки та фінальної формули зважування.

---

## 1. Рівень "Raw Confidence": Аналіз LogProbs та Тест Колмогорова-Смирнова (K-S)

Це перший "запобіжник", який працює на рівні ймовірностей генерації токенів моделі.

### ⚙️ Як це працює:
1.  **Збір даних:** Під час генерації ми отримуємо від OpenAI `logprobs` для кожного токена.
2.  **Розрахунок впевненості:** Обчислюємо середнє логарифмічне значення ймовірностей для всього тексту відповіді.
3.  **K-S Тест (Kolmogorov-Smirnov):**
    *   Ми порівнюємо емпіричний розподіл ймовірностей поточної відповіді з "еталонним" розподілом (який ми заздалегідь накопичили для правильних відповідей у медичній базі знань).
    *   Якщо статистика $D$ (максимальна відстань між функціями розподілу) перевищує критичний поріг (наприклад, **0.163** для $\alpha=0.01$), ми вважаємо відповідь аномальною.

> **Навіщо це:** Це дозволяє виявити ситуації **"Out-of-Distribution" (OOD)**, коли модель починає галюцинувати, генеруючи токени з нетиповим для медичного контексту розподілом впевненості.

---

## 2. Рівень "Consistency": Семантична диверсифікація та Self-Consistency

Підхід базується на методі **Self-Consistency (Majority Voting)**.

### ⚙️ Процес:
1.  **Генерація гіпотез:** Робимо $N$ паралельних запитів (наприклад, 3 або 5) до LLM з високою температурою ($T > 0.5$).
2.  **Векторизація:** Отримуємо ембеддінги для кожної відповіді через `OpenAIEmbeddingService`.
3.  **Матриця подібності (Cosine Similarity):** Розраховуємо косинусну близькість між усіма парами гіпотез.
4.  **Оцінка стійкості:** Якщо гіпотези сильно розбігаються (низька середня подібність), це свідчить про низьку впевненість системи в результаті. Ми шукаємо "кластер згоди".

---

## 3. Рівень "Self-Reflection": Самооцінка моделі

Це підхід, коли модель оцінює власну відповідь (LLM-as-a-Judge).

### ⚙️ Етапи:
1.  **Second Pass (Validator Role):** Отримана відповідь передається окремому екземпляру моделі з роллю "Медичний валідатор".
2.  **Аналіз суперечностей:** Валідатор перевіряє відповідь на відповідність вхідним даним (лабораторним показникам) та наявність внутрішніх логічних протиріч.
3.  **Confidence Score:** Модель просять виставити оцінку впевненості від **0 до 1** та обґрунтувати її (Chain-of-Thought).

---

## 4. Рівень "RAG Diversity": Індекс Херфіндаля-Хіршмана (HHI)

Додатковий математичний інструмент для оцінки якості джерел знань, використаних у RAG.

### ⚙️ Методика:
1.  **Аналіз джерел:** Рахуємо, з якої кількості різних медичних протоколів було взято чанки для формування відповіді.
2.  **Розрахунок HHI:**
    *   Якщо індекс наближається до **1**, це означає, що відповідь базується лише на одному джерелі (ризик упередженості).
    *   Низький показник HHI (висока диверсифікація джерел) додає "балів" до загальної впевненості.

---

## 📊 Підсумкова формула оцінки (Final Score)

Кінцевий статус впевненості `ConfidenceResult` формується як зважена сума:

| Компонент | Вага | Опис |
| :--- | :---: | :--- |
| **Математична вага** | **40%** | K-S Test + LogProbs |
| **Семантична вага** | **30%** | Self-Consistency |
| **Експертна вага** | **20%** | Self-Reflection |
| **Вага знань** | **10%** | HHI Index (Diversity) |

### Результат роботи алгоритму:

*   **Score:** Число від 0 до 1.
*   **Status:**
    *   🟢 **High** — Відповідь надійна.
    *   🟡 **Medium** — Потребує уваги.
    *   🔴 **Low** — `MedicalOrchestrator` повинен зупинити потік і вимагати втручання лікаря.
*   **Details:** Опис причини (наприклад: *"Статистична аномалія в LogProbs"* або *"Суперечливі гіпотези"*).
